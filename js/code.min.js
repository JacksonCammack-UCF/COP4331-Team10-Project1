const isTestPath=location.pathname.startsWith("/test/"),urlBase=`${location.origin}${isTestPath?"/test/LAMPAPI":"/LAMPAPI"}`,extension="php";let userId=0,firstName="",lastName="",editingId=null;const NEXT_PAGE="contacts.html",$=e=>document.getElementById(e),setText=(e,t)=>{const a=$(e);a&&(a.textContent=t??"")};function setAlert(e,t,a){const r=$(e);r&&(r.className="success"===t?"text-success":"danger"===t?"text-danger":"text-muted",r.textContent=a||"")}function escapeHTML(e){return String(e??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function postJSON(e,t={}){return fetch(`${urlBase}/${e}.php`,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(t)}).then(async e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.text();if(!t)return{};try{return JSON.parse(t)}catch{return{}}})}function doLogin(){userId=0,firstName="",lastName="";const e=$("loginName")?.value?.trim()||"",t=$("loginPassword")?.value||"";setAlert("loginResult","",""),e&&t?postJSON("Login",{login:e,password:t}).then(e=>{const t=Number(e.id||0);t<1?setAlert("loginResult","danger","User/Password combination incorrect"):(userId=t,firstName=e.firstName||"",lastName=e.lastName||"",saveCookie(),window.location.href=NEXT_PAGE)}).catch(e=>setAlert("loginResult","danger",e.message||"Login failed")):setAlert("loginResult","danger","Enter username and password.")}function saveCookie(){const e={userId:userId,firstName:firstName,lastName:lastName,expires:Date.now()+12e5};try{localStorage.setItem("user",JSON.stringify(e))}catch(e){}}function readCookie(){try{const e=localStorage.getItem("user");if(!e)return userId=0,firstName="",void(lastName="");const t=JSON.parse(e)||{};if(t.expires&&Date.now()>t.expires)return localStorage.removeItem("user"),userId=0,firstName="",void(lastName="");userId=Number(t.userId)||0,firstName=t.firstName||"",lastName=t.lastName||""}catch(e){userId=0,firstName="",lastName=""}}function doLogout(){userId=0,firstName="",lastName="";try{localStorage.removeItem("user")}catch(e){}window.location.href="index.html"}const validEmail=e=>!e||/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(e),validPhone=e=>!e||/^[0-9]{7,20}$/.test(e);function addContact(){setAlert("addResult","","");const e=$("firstName")?.value?.trim()||"",t=$("lastName")?.value?.trim()||"",a=$("email")?.value?.trim()||"",r=$("phone")?.value?.trim()||"";if(!e||!t)return void setAlert("addResult","danger","First and Last are required.");if(!validEmail(a))return void setAlert("addResult","danger","Invalid email.");if(!validPhone(r))return void setAlert("addResult","danger","Invalid phone.");if(userId<1)return void setAlert("addResult","danger","Not authenticated.");postJSON("AddContact",{firstName:e,lastName:t,email:a,phone:r,userID:userId}).then(e=>{e&&e.error?setAlert("addResult","danger",e.error):(setAlert("addResult","success","Contact has been added"),["firstName","lastName","email","phone"].forEach(e=>{const t=$(e);t&&(t.value="")}),searchContacts())}).catch(e=>setAlert("addResult","danger",e.message||"Add failed"))}let searchTimer=null;function debouncedSearch(e=250){clearTimeout(searchTimer),searchTimer=setTimeout(searchContacts,e)}function searchContacts(){const e=$("search")?.value?.trim()??"",t=parseInt($("limitSelect")?.value||"10",10)||10;userId<1?setAlert("contactSearchResult","danger","Not authenticated."):(setAlert("contactSearchResult","muted","Searching..."),postJSON("SearchContacts",{search:e,userID:userId,limit:t,offset:0}).then(e=>{let t=[];Array.isArray(e.results)?t=e.results:Array.isArray(e.Contacts)?t=e.Contacts:Array.isArray(e.contacts)?t=e.contacts:e&&"object"==typeof e&&(!e.error||e.id&&0!==Number(e.id)?("id"in e||"ID"in e||"Id"in e)&&(t=[e]):t=[]),renderResults(t);const a=$("totalCount");a&&(a.textContent=String(e.total??(Array.isArray(t)?t.length:0))),t.length?setAlert("contactSearchResult","muted","Contact(s) have been retrieved"):setAlert("contactSearchResult","danger",e.error||"No contacts found")}).catch(e=>setAlert("contactSearchResult","danger",e.message||"Search failed")))}function renderResults(e){const t=$("resultsBody");t&&(Array.isArray(e)&&0!==e.length?t.innerHTML=e.map(e=>{if("string"==typeof e)return`<tr>\n          <td colspan="3">${escapeHTML(e)}</td>\n          <td class="text-end"></td>\n        </tr>`;const t=Number(e.id??e.ID??e.Id)||0,a=e.firstName??e.FirstName??"",r=e.lastName??e.LastName??"",n=e.email??e.Email??"",s=e.phone??e.Phone??"",i=`${a} ${r}`.trim(),o=t&&editingId===t,l=o?`<div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">\n             <input id="fn-${t}" value="${escapeHTML(a)}" placeholder="First name" />\n             <input id="ln-${t}" value="${escapeHTML(r)}"  placeholder="Last name" />\n           </div>`:escapeHTML(i),d=o?`<input id="em-${t}" value="${escapeHTML(n)}" placeholder="Email" />`:escapeHTML(n),c=o?`<input id="ph-${t}" value="${escapeHTML(s)}" placeholder="Phone" inputmode="numeric" pattern="[0-9]*"\n                  oninput="this.value=this.value.replace(/[^0-9]/g,'');" />`:escapeHTML(s);let u="";return t&&(u=o?`<button class="action-btn" onclick="saveRowEdit(${t})">Save</button>\n             <button class="action-btn secondary" onclick="cancelRowEdit()">Cancel</button>`:`<button class="action-btn secondary" data-first="${escapeHTML(a)}" data-last="${escapeHTML(r)}" data-email="${escapeHTML(n)}" data-phone="${escapeHTML(s)}" onclick="enterRowEdit(${t})">Edit</button>\n             <span class="danger-text" onclick="deleteContact(${t})">Delete</span>`),`\n        <tr>\n          <td>${l}</td>\n          <td>${d}</td>\n          <td>${c}</td>\n          <td class="text-end">${u}</td>\n        </tr>\n      `}).join(""):t.innerHTML="")}function enterRowEdit(e){editingId=e,searchContacts()}function cancelRowEdit(){editingId=null,searchContacts()}function saveRowEdit(e){if(userId<1)return void alert("Not authenticated.");if(!e)return void alert("Missing contact id.");const t=document.getElementById(`fn-${e}`)?.value.trim()||"",a=document.getElementById(`ln-${e}`)?.value.trim()||"",r=document.getElementById(`em-${e}`)?.value.trim()||"",n=document.getElementById(`ph-${e}`)?.value.trim()||"";if(!t||!a)return void alert("First and Last are required.");if(!validEmail(r))return void alert("Invalid email.");if(!validPhone(n))return void alert("Invalid phone.");postJSON("UpdateContact",{id:e,userID:userId,firstName:t,lastName:a,email:r,phone:n}).then(e=>{e&&e.error?alert(e.error):(editingId=null,searchContacts())}).catch(e=>alert(e.message||"Update failed"))}function deleteContact(e){if(!e)return;if(!confirm("Delete this contact?"))return;if(userId<1)return void alert("Not authenticated.");postJSON("DeleteContact",{id:e,ID:e,userID:userId,UserID:userId}).then(e=>{e&&e.error?alert(e.error):searchContacts()}).catch(e=>alert(e.message||"Delete failed"))}function editContact(e,t){if(userId<1)return void alert("Not authenticated.");if(!t)return;const a=e?.dataset?.first||"",r=e?.dataset?.last||"",n=e?.dataset?.email||"",s=e?.dataset?.phone||"",i=(prompt("Enter first name:",a)??"").trim(),o=(prompt("Enter last name:",r)??"").trim(),l=(prompt("Enter email:",n)??"").trim(),d=(prompt("Enter phone:",s)??"").trim();if(!i||!o)return void alert("First and Last are required.");if(!validEmail(l))return void alert("Invalid email.");if(!validPhone(d))return void alert("Invalid phone.");postJSON("UpdateContact",{id:t,userID:userId,firstName:i,lastName:o,email:l,phone:d}).then(e=>{e&&e.error?alert(e.error):searchContacts()}).catch(e=>console.error(e))}function doRegister(){const e=$("regFirstName")?.value?.trim()||"",t=$("regLastName")?.value?.trim()||"",a=$("regUsername")?.value?.trim()||"",r=$("regPassword")?.value||"";if(setAlert("registerResult","",""),!(e&&t&&a&&r))return void setAlert("registerResult","danger","Please fill in all fields.");if(a.length<2)return void setAlert("registerResult","danger","Username must be at least 2 characters.");if(r.length<8)return void setAlert("registerResult","danger","Password must be at least 8 characters.");postJSON("Register",{firstName:e,lastName:t,login:a,password:r,FirstName:e,LastName:t,Login:a,Password:r}).then(e=>{e&&e.error?setAlert("registerResult","danger",e.error):(setAlert("registerResult","success","Account created! You can now log in."),setTimeout(()=>{window.location.href="index.html"},900))}).catch(e=>setAlert("registerResult","danger",e.message||"Registration failed"))}window.doLogin=doLogin,window.readCookie=readCookie,window.doLogout=doLogout,window.addContact=addContact,window.searchContacts=searchContacts,window.deleteContact=deleteContact,window.doRegister=doRegister,window.debouncedSearch=debouncedSearch,window.enterRowEdit=enterRowEdit,window.cancelRowEdit=cancelRowEdit,window.saveRowEdit=saveRowEdit;